---
title: "Azure 金鑰保存庫的組態提供者"
author: guardrex
description: "了解如何使用 Azure 金鑰保存庫的組態提供者設定應用程式使用在執行階段載入的名稱 / 值組。"
keywords: "ASP.NET Core，組態中，Azure 金鑰保存庫"
ms.author: riande
manager: wpickett
ms.date: 08/09/2017
ms.topic: article
ms.assetid: 0292bdae-b3ed-4637-bd67-19b9bb8b65cb
ms.prod: asp.net-core
uid: security/key-vault-configuration
ms.openlocfilehash: 2c94daafec8d3b4051bd3091478521ab12a434bd
ms.sourcegitcommit: 78d28178345a0eea91556e4cd1adad98b1446db8
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/22/2017
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="b7d42-104">Azure 金鑰保存庫的組態提供者</span><span class="sxs-lookup"><span data-stu-id="b7d42-104">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="b7d42-105">由[Luke Latham](https://github.com/GuardRex)和[Andrew Stanton 護士](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="b7d42-105">By [Luke Latham](https://github.com/GuardRex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="b7d42-106">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="b7d42-106">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="b7d42-107">檢視或下載 2.x 的範例程式碼：</span><span class="sxs-lookup"><span data-stu-id="b7d42-107">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="b7d42-108">[基本範例](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x)-讀取到應用程式的密碼值。</span><span class="sxs-lookup"><span data-stu-id="b7d42-108">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="b7d42-109">[索引鍵名稱前置詞範例](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x)-讀取密碼的值，以代表版本的應用程式，這可讓您載入一組不同的每個應用程式版本的密碼值的索引鍵名稱前置詞。</span><span class="sxs-lookup"><span data-stu-id="b7d42-109">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="b7d42-110">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="b7d42-110">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="b7d42-111">檢視或下載 1.x 的範例程式碼：</span><span class="sxs-lookup"><span data-stu-id="b7d42-111">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="b7d42-112">[基本範例](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x)-讀取到應用程式的密碼值。</span><span class="sxs-lookup"><span data-stu-id="b7d42-112">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) - Reads secret values into an app.</span></span>
* <span data-ttu-id="b7d42-113">[索引鍵名稱前置詞範例](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x)-讀取密碼的值，以代表版本的應用程式，這可讓您載入一組不同的每個應用程式版本的密碼值的索引鍵名稱前置詞。</span><span class="sxs-lookup"><span data-stu-id="b7d42-113">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="b7d42-114">本文件說明如何使用[Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/)從 Azure 金鑰保存庫密碼載入應用程式組態值的組態提供者。</span><span class="sxs-lookup"><span data-stu-id="b7d42-114">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="b7d42-115">Azure 金鑰保存庫是以雲端為基礎的服務，可協助您保護密碼編譯金鑰和應用程式和服務所使用的密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-115">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="b7d42-116">常見的案例包括敏感的組態資料控制存取，但符合 FIPS 140-2 的需求層級 2 硬體安全性模組 (HSM) 時驗證儲存設定資料。</span><span class="sxs-lookup"><span data-stu-id="b7d42-116">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="b7d42-117">這項功能是適用於 ASP.NET Core 1.1 版為目標的應用程式或更高版本。</span><span class="sxs-lookup"><span data-stu-id="b7d42-117">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="b7d42-118">Package</span><span class="sxs-lookup"><span data-stu-id="b7d42-118">Package</span></span>
<span data-ttu-id="b7d42-119">若要使用的提供者，將參考加入[Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/)封裝。</span><span class="sxs-lookup"><span data-stu-id="b7d42-119">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="b7d42-120">應用程式組態</span><span class="sxs-lookup"><span data-stu-id="b7d42-120">Application configuration</span></span>
<span data-ttu-id="b7d42-121">您可以瀏覽的提供者[範例應用程式](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-121">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="b7d42-122">一旦您建立金鑰保存庫，並在保存庫中建立密碼，範例應用程式安全地載入其組態中密碼的值，並在網頁中顯示。</span><span class="sxs-lookup"><span data-stu-id="b7d42-122">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="b7d42-123">提供者加入至`ConfigurationBuilder`與`AddAzureKeyVault`延伸模組。</span><span class="sxs-lookup"><span data-stu-id="b7d42-123">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="b7d42-124">範例應用程式中延伸模組會使用三個從載入的組態值*appsettings.json*檔案。</span><span class="sxs-lookup"><span data-stu-id="b7d42-124">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="b7d42-125">應用程式設定</span><span class="sxs-lookup"><span data-stu-id="b7d42-125">App Setting</span></span>    | <span data-ttu-id="b7d42-126">說明</span><span class="sxs-lookup"><span data-stu-id="b7d42-126">Description</span></span>                    | <span data-ttu-id="b7d42-127">範例</span><span class="sxs-lookup"><span data-stu-id="b7d42-127">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="b7d42-128">Azure 金鑰保存庫名稱</span><span class="sxs-lookup"><span data-stu-id="b7d42-128">Azure Key Vault name</span></span>           | <span data-ttu-id="b7d42-129">contosovault</span><span class="sxs-lookup"><span data-stu-id="b7d42-129">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="b7d42-130">Azure Active Directory 應用程式識別碼</span><span class="sxs-lookup"><span data-stu-id="b7d42-130">Azure Active Directory App Id</span></span>  | <span data-ttu-id="b7d42-131">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="b7d42-131">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="b7d42-132">Azure Active Directory 應用程式金鑰</span><span class="sxs-lookup"><span data-stu-id="b7d42-132">Azure Active Directory App Key</span></span> | <span data-ttu-id="b7d42-133">g58K3dtg59o1Pa + e59v2Tx829w6VxTB2yv9sv/101di =</span><span class="sxs-lookup"><span data-stu-id="b7d42-133">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="b7d42-134">建立金鑰保存庫密碼並載入組態值 （basic 範例）</span><span class="sxs-lookup"><span data-stu-id="b7d42-134">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="b7d42-135">建立金鑰保存庫，並設定下列中的指導方針的應用程式的 Azure Active Directory (Azure AD)[開始使用 Azure 金鑰保存庫](https://azure.microsoft.com/documentation/articles/key-vault-get-started/)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-135">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="b7d42-136">將密碼加入金鑰保存庫使用[AzureRM 金鑰保存庫 PowerShell 模組](/powershell/module/azurerm.keyvault)可從[PowerShell 資源庫](https://www.powershellgallery.com/packages/AzureRM.KeyVault)、 [Azure 金鑰保存庫 REST API](/rest/api/keyvault/)，或[Azure 入口網站](https://portal.azure.com/)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-136">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="b7d42-137">密碼會建立為*手動*或*憑證*機密資料。</span><span class="sxs-lookup"><span data-stu-id="b7d42-137">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="b7d42-138">*憑證*密碼使用的應用程式和服務憑證，但不是支援的組態提供者。</span><span class="sxs-lookup"><span data-stu-id="b7d42-138">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="b7d42-139">您應該使用*手動*選項建立的組態提供者使用的名稱 / 值組密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-139">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="b7d42-140">簡單密碼，會建立為名稱 / 值組。</span><span class="sxs-lookup"><span data-stu-id="b7d42-140">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="b7d42-141">Azure 金鑰保存庫密碼名稱會限制為英數字元及虛線。</span><span class="sxs-lookup"><span data-stu-id="b7d42-141">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="b7d42-142">使用階層式的值 （組態區段） `--` （兩個破折號） 做為範例中的分隔符號。</span><span class="sxs-lookup"><span data-stu-id="b7d42-142">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="b7d42-143">通常用來分隔區段中的，從子機碼中的冒號[ASP.NET Core 組態](xref:fundamentals/configuration)，秘密名稱中不允許。</span><span class="sxs-lookup"><span data-stu-id="b7d42-143">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration), aren't allowed in secret names.</span></span> <span data-ttu-id="b7d42-144">因此，使用兩個破折號和機密資料載入至應用程式的組態時，已還原為冒號。</span><span class="sxs-lookup"><span data-stu-id="b7d42-144">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="b7d42-145">建立兩個*手動*具有下列名稱 / 值組的密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-145">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="b7d42-146">第一個密碼是簡單名稱和值，並以第二個密碼建立祕密值區段和秘密名稱中的子機碼：</span><span class="sxs-lookup"><span data-stu-id="b7d42-146">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="b7d42-147">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="b7d42-147">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="b7d42-148">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="b7d42-148">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="b7d42-149">向 Azure Active Directory 中註冊範例應用程式。</span><span class="sxs-lookup"><span data-stu-id="b7d42-149">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="b7d42-150">授權應用程式存取金鑰保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-150">Authorize the app to access the key vault.</span></span> <span data-ttu-id="b7d42-151">當您使用`Set-AzureRmKeyVaultAccessPolicy`PowerShell cmdlet，以授權應用程式存取金鑰保存庫中，提供`List`和`Get`密碼與存取`-PermissionsToKeys list,get`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-151">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="b7d42-152">更新應用程式的*appsettings.json*檔案使用的數值`Vault`， `ClientId`，和`ClientSecret`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-152">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="b7d42-153">執行範例應用程式，會取得從其組態值`IConfigurationRoot`具有相同名稱與密碼的名稱。</span><span class="sxs-lookup"><span data-stu-id="b7d42-153">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="b7d42-154">非階層式的值： 的值`SecretName`取得`config["SecretName"]`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-154">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="b7d42-155">階層值 （區段）： 使用`:`（冒號） 標記法或`GetSection`擴充方法。</span><span class="sxs-lookup"><span data-stu-id="b7d42-155">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="b7d42-156">您可以使用任一種方法來取得組態值：</span><span class="sxs-lookup"><span data-stu-id="b7d42-156">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="b7d42-157">當您執行應用程式時，網頁就會顯示載入的祕密值：</span><span class="sxs-lookup"><span data-stu-id="b7d42-157">When you run the app, a webpage shows the loaded secret values:</span></span>

![透過 Azure 金鑰保存庫的組態提供者載入瀏覽器視窗中顯示密碼的值](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="b7d42-159">建立帶有前置詞的金鑰保存庫密碼並載入組態值 （索引鍵-名稱-前置詞的範例）</span><span class="sxs-lookup"><span data-stu-id="b7d42-159">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="b7d42-160">`AddAzureKeyVault`也會提供多載，可接受的實作`IKeyVaultSecretManager`，可讓您控制如何金鑰保存庫密碼會轉換成組態機碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-160">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="b7d42-161">例如，您可以實作的介面，根據您在應用程式啟動時提供的前置詞值的密碼值載入。</span><span class="sxs-lookup"><span data-stu-id="b7d42-161">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="b7d42-162">這可讓您，例如，若要載入的應用程式版本為基礎的密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-162">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="b7d42-163">將多個應用程式的秘密資訊放入相同的金鑰保存庫，或將環境的機密資料，不使用前置詞在金鑰保存庫密碼 (例如，*開發*verus*生產*密碼) 放在同一個保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-163">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* verus *production* secrets) into the same vault.</span></span> <span data-ttu-id="b7d42-164">我們建議不同的應用程式和開發/生產環境使用不同的金鑰保存庫來隔離應用程式環境，最高的層級的安全性。</span><span class="sxs-lookup"><span data-stu-id="b7d42-164">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="b7d42-165">使用第二個範例應用程式，您會建立金鑰保存庫，以在執行密碼`5000-AppSecret`（期間不允許在金鑰保存庫密碼名稱） 代表應用程式的版本 5.0.0.0 應用程式密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-165">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="b7d42-166">如需其他版本，5.1.0.0，您建立的密碼`5100-AppSecret`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-166">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="b7d42-167">每個應用程式版本會將其設定為載入它自己的密碼值`AppSecret`、 清除關閉版本載入密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-167">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="b7d42-168">範例的實作如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7d42-168">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="b7d42-169">`Load`逐一，找出有版本前置詞的保存庫密碼提供者演算法所呼叫方法。</span><span class="sxs-lookup"><span data-stu-id="b7d42-169">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="b7d42-170">在找到版本前置詞與`Load`，此演算法會使用`GetKey`方法傳回之組態名稱的密碼的名稱。</span><span class="sxs-lookup"><span data-stu-id="b7d42-170">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="b7d42-171">它會剝版本前置詞之密碼的名稱，並傳回至應用程式的組態名稱 / 值組的載入的秘密名稱的其餘部分。</span><span class="sxs-lookup"><span data-stu-id="b7d42-171">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="b7d42-172">當您實作這個方法：</span><span class="sxs-lookup"><span data-stu-id="b7d42-172">When you implement this approach:</span></span>

1. <span data-ttu-id="b7d42-173">會載入金鑰保存庫密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-173">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="b7d42-174">字串密碼`5000-AppSecret`時要比對。</span><span class="sxs-lookup"><span data-stu-id="b7d42-174">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="b7d42-175">版本`5000`（與虛線），移除不保留索引鍵名稱`AppSecret`祕密值與載入應用程式的組態。</span><span class="sxs-lookup"><span data-stu-id="b7d42-175">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="b7d42-176">您也可以提供您自己`KeyVaultClient`實作`AddAzureKeyVault`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-176">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="b7d42-177">提供自訂用戶端，可讓您共用的組態提供者與您的應用程式的其他部分之間的用戶端的單一執行個體。</span><span class="sxs-lookup"><span data-stu-id="b7d42-177">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="b7d42-178">建立金鑰保存庫，並設定下列中的指導方針的應用程式的 Azure Active Directory (Azure AD)[開始使用 Azure 金鑰保存庫](https://azure.microsoft.com/documentation/articles/key-vault-get-started/)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-178">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="b7d42-179">將密碼加入金鑰保存庫使用[AzureRM 金鑰保存庫 PowerShell 模組](/powershell/module/azurerm.keyvault)可從[PowerShell 資源庫](https://www.powershellgallery.com/packages/AzureRM.KeyVault)、 [Azure 金鑰保存庫 REST API](/rest/api/keyvault/)，或[Azure 入口網站](https://portal.azure.com/)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-179">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="b7d42-180">密碼會建立為*手動*或*憑證*機密資料。</span><span class="sxs-lookup"><span data-stu-id="b7d42-180">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="b7d42-181">*憑證*密碼使用的應用程式和服務憑證，但不是支援的組態提供者。</span><span class="sxs-lookup"><span data-stu-id="b7d42-181">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="b7d42-182">您應該使用*手動*選項建立的組態提供者使用的名稱 / 值組密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-182">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="b7d42-183">使用階層式的值 （組態區段） `--` （兩個破折號） 做為分隔符號。</span><span class="sxs-lookup"><span data-stu-id="b7d42-183">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="b7d42-184">建立兩個*手動*具有下列名稱 / 值組的密碼：</span><span class="sxs-lookup"><span data-stu-id="b7d42-184">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="b7d42-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="b7d42-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="b7d42-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="b7d42-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="b7d42-187">向 Azure Active Directory 中註冊範例應用程式。</span><span class="sxs-lookup"><span data-stu-id="b7d42-187">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="b7d42-188">授權應用程式存取金鑰保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-188">Authorize the app to access the key vault.</span></span> <span data-ttu-id="b7d42-189">當您使用`Set-AzureRmKeyVaultAccessPolicy`PowerShell cmdlet，以授權應用程式存取金鑰保存庫中，提供`List`和`Get`密碼與存取`-PermissionsToKeys list,get`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-189">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="b7d42-190">更新應用程式的*appsettings.json*檔案使用的數值`Vault`， `ClientId`，和`ClientSecret`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-190">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="b7d42-191">執行範例應用程式，會取得從其組態值`IConfigurationRoot`具有相同名稱做為帶有前置詞的秘密名稱。</span><span class="sxs-lookup"><span data-stu-id="b7d42-191">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="b7d42-192">在此範例中，前置詞是應用程式的版本，您提供給`PrefixKeyVaultSecretManager`當您加入的 Azure 金鑰保存庫的組態提供者。</span><span class="sxs-lookup"><span data-stu-id="b7d42-192">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="b7d42-193">值`AppSecret`取得`config["AppSecret"]`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-193">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="b7d42-194">應用程式所產生的網頁顯示載入的值：</span><span class="sxs-lookup"><span data-stu-id="b7d42-194">The webpage generated by the app shows the loaded value:</span></span>

   ![透過 Azure 金鑰保存庫的組態提供者應用程式的版本時 5.0.0.0 載入的瀏覽器視窗中顯示的密碼值](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="b7d42-196">變更應用程式中的組件的專案檔版本`5.0.0.0`至`5.1.0.0`，然後再次執行應用程式。</span><span class="sxs-lookup"><span data-stu-id="b7d42-196">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="b7d42-197">此時，傳回的密碼值是`5.1.0.0_secret_value`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-197">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="b7d42-198">應用程式所產生的網頁顯示載入的值：</span><span class="sxs-lookup"><span data-stu-id="b7d42-198">The webpage generated by the app shows the loaded value:</span></span>

   ![透過 Azure 金鑰保存庫的組態提供者應用程式的版本時 5.1.0.0 載入的瀏覽器視窗中顯示的密碼值](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="b7d42-200">ClientSecret 控制的存取</span><span class="sxs-lookup"><span data-stu-id="b7d42-200">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="b7d42-201">使用[密碼管理員工具](xref:security/app-secrets)維護`ClientSecret`專案原始檔樹狀之外。</span><span class="sxs-lookup"><span data-stu-id="b7d42-201">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="b7d42-202">使用密碼管理員，您將應用程式密碼與特定的專案產生關聯並共用跨多個專案。</span><span class="sxs-lookup"><span data-stu-id="b7d42-202">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="b7d42-203">當開發.NET Framework 應用程式支援憑證的環境中，您可以使用 X.509 憑證來驗證 Azure 金鑰保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-203">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="b7d42-204">X.509 憑證的私密金鑰是由作業系統負責管理。</span><span class="sxs-lookup"><span data-stu-id="b7d42-204">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="b7d42-205">如需詳細資訊，請參閱[驗證的憑證，而不是用戶端密碼](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-205">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="b7d42-206">使用`AddAzureKeyVault`多載會接受`X509Certificate2`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-206">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="b7d42-207">重新載入密碼</span><span class="sxs-lookup"><span data-stu-id="b7d42-207">Reloading secrets</span></span>
<span data-ttu-id="b7d42-208">密碼會快取直到`IConfigurationRoot.Reload()`呼叫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-208">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="b7d42-209">過期時，停用，而金鑰保存庫中的更新的密碼不會代表應用程式，直到`Reload`執行。</span><span class="sxs-lookup"><span data-stu-id="b7d42-209">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="b7d42-210">已停用及過期的密碼</span><span class="sxs-lookup"><span data-stu-id="b7d42-210">Disabled and expired secrets</span></span>
<span data-ttu-id="b7d42-211">已停用及過期的密碼會擲回`KeyVaultClientException`。</span><span class="sxs-lookup"><span data-stu-id="b7d42-211">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="b7d42-212">若要防止您的應用程式擲回，取代您的應用程式或更新已停用/過期的密碼。</span><span class="sxs-lookup"><span data-stu-id="b7d42-212">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="b7d42-213">疑難排解</span><span class="sxs-lookup"><span data-stu-id="b7d42-213">Troubleshooting</span></span>
<span data-ttu-id="b7d42-214">當應用程式無法載入組態使用的提供者時，錯誤訊息會寫入[ASP.NET 記錄基礎結構](xref:fundamentals/logging)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-214">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging).</span></span> <span data-ttu-id="b7d42-215">在下列情況會造成無法載入組態：</span><span class="sxs-lookup"><span data-stu-id="b7d42-215">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="b7d42-216">應用程式未正確設定 Azure Active Directory 中。</span><span class="sxs-lookup"><span data-stu-id="b7d42-216">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="b7d42-217">金鑰保存庫不存在於 Azure 金鑰保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-217">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="b7d42-218">應用程式未獲授權存取金鑰保存庫。</span><span class="sxs-lookup"><span data-stu-id="b7d42-218">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="b7d42-219">存取原則不包括`Get`和`List`權限。</span><span class="sxs-lookup"><span data-stu-id="b7d42-219">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="b7d42-220">在金鑰保存庫中，設定資料 （名稱 / 值組） 是正確命名，遺失，停用，或已過期。</span><span class="sxs-lookup"><span data-stu-id="b7d42-220">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="b7d42-221">應用程式有錯誤的金鑰保存庫名稱 (`Vault`)，Azure AD 應用程式識別碼 (`ClientId`)，或 Azure AD 的索引鍵 (`ClientSecret`)。</span><span class="sxs-lookup"><span data-stu-id="b7d42-221">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="b7d42-222">Azure AD 金鑰 (`ClientSecret`) 已過期。</span><span class="sxs-lookup"><span data-stu-id="b7d42-222">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="b7d42-223">設定索引鍵 （名稱） 不正確的值，您想要載入的應用程式中。</span><span class="sxs-lookup"><span data-stu-id="b7d42-223">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="b7d42-224">其他資源</span><span class="sxs-lookup"><span data-stu-id="b7d42-224">Additional resources</span></span>
* <xref:fundamentals/configuration>
* [<span data-ttu-id="b7d42-225">Microsoft Azure： 金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="b7d42-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="b7d42-226">Microsoft Azure： 金鑰保存庫文件</span><span class="sxs-lookup"><span data-stu-id="b7d42-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="b7d42-227">如何產生並傳輸受 HSM 保護金鑰的 Azure 金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="b7d42-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="b7d42-228">KeyVaultClient 類別</span><span class="sxs-lookup"><span data-stu-id="b7d42-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
